#cloud-config

# Update and install packages
package_update: true
package_upgrade: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - git

# Create deploy user
users:
  - name: deploy
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${ssh_public_key}

# Write files
write_files:
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 5
      bantime = 3600

# Run commands
runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com | sh

  # Add deploy user to docker group (in case cloud-init didn't)
  - usermod -aG docker deploy

  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  - ufw --force enable

  # Start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Clone application repository and create data directories
  - git clone https://github.com/Daymannovaes/BotEco.git /opt/wpp-bot
  - mkdir -p /opt/wpp-bot/data/auth_info
  - mkdir -p /opt/wpp-bot/data/cache
  - chown -R deploy:deploy /opt/wpp-bot

  # Install Docker Compose plugin
  - mkdir -p /usr/local/lib/docker/cli-plugins
  - curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
  - chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Final message
final_message: "WPP-Bot VPS setup complete after $UPTIME seconds"
